<!DOCTYPE html>
<html>
<head>
    <title>Streemian Add Posting Keys</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link href='https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="app.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12 col-sm-8 col-sm-offset-2 text-center">
                <h2>Streemian Posting Key Adder</h2>
            </div>
        </div>
        <br />

        <div class="row">
            <form id="form" class="col-xs-12 col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">

                <div class="form-group">
                    <label><i class="fa fa-user"></i> Account Name</label>
                    <input id="account_name" class="form-control Streemian__input" type=text name="name" />
                    <div id="account_check" class="Streemian__check pull-right"><i class="fa fa-check"></i></div>
                </div>

                <div class="form-group">
                    <label><i class="fa fa-key"></i> Password</label>

                    <input id="password" class="form-control Streemian__input" class="form-control" type=password name="password" />
                    <div id="password_check" class="Streemian__check pull-right"><i class="fa fa-check"></i></div>

                </div>

                <div class="form-group" id="current_auths"></div>

                <div class="form-group" id="posters"></div>

                <button id="submit_button" type="submit" class="btn btn-primary disabled">Add streemian</button>

                <div id="error_div">
                    <p id="error_warning"></p>
                </div>

                <div class="">
                    <h4 id="success_message"></h4>
                </div>


            </form>
        </div>
    </div>
    <script src="./bundle.js"></script>
    <script type="text/javascript">

        var options = {
            apis: ["database_api", "network_broadcast_api"],
            url: "wss://node.steem.ws"
        };
        var Client = window.bundle.Client;
        var Api = Client.get(options, true);

        Api.initPromise.then(function(res) {
            console.log("Api ready", res);
        });

        var account;
        var accountToAdd = "streemian";

        var posterCount = 1;
        var postersDiv =  document.getElementById("posters");

        var accountNameInput = document.getElementById("account_name");
        accountNameInput.onchange = lookUpAccount;

        var submitButton = document.getElementById("submit_button");

        var form = document.getElementById("form");
        function nullFunction(e) {
            e.preventDefault();
        }
        form.onsubmit = nullFunction;

        var checkClass = "Streemian__check pull-right success";
        function lookUpAccount() {

            Api.database_api().exec("get_accounts", [ [accountNameInput.value] ]).then(function(res) {
                console.log("account:", res[0]);
                var accountCheck = document.getElementById("account_check");

                account = res[0];
                if (!res[0]) {
                    submitButton.className = "btn btn-success disabled";
                    accountCheck.className = checkClass;
                    form.onsubmit = nullFunction;
                } else {
                    accountCheck.className = checkClass + " visible";
                    form.onsubmit = addStreemian;
                }

                checkAuths(res[0]);
            });
        }

        function checkAuths(account) {
            if (!account) {
                submitButton.innerText = "Add streemian";
                submitButton.className = "btn btn-success disabled";
                form.onsubmit = nullFunction;
            } else {
                var hasStreemian = false;
                account.posting.account_auths.forEach(function(auth) {
                    if (auth[0] === accountToAdd) {
                        hasStreemian = true;
                    }
                });

                if (hasStreemian) {
                    submitButton.innerText = "Remove streemian";
                    submitButton.className = "btn btn-danger";
                    form.onsubmit = removeStreemian;
                } else {
                    submitButton.innerText = "Add streemian";
                    submitButton.className = "btn btn-success";
                    form.onsubmit = addStreemian;
                }
            }
        }

        function setPasswordIncorrect() {
            document.getElementById("error_warning").innerText = "Password or active private key incorrect, please try again.";
            document.getElementById("error_div").className = "danger";
            document.getElementById("success_message").innerText = "";
        }

        function removeStreemian(e) {
            e.preventDefault();

            var accountName = document.getElementById("account_name").value;
            var password = document.getElementById("password").value;
            var login = verifyLogin(account, password, null);
            if (!login) {
                setPasswordIncorrect();
                return;
            } else {
                document.getElementById("error_div").className = "";
                document.getElementById("error_warning").innerText = "";
            }

            var postingAuth = account.posting;

            for (var i = 0; i < postingAuth.account_auths.length; i++) {
                if (postingAuth.account_auths[i][0] === accountToAdd) {
                    break;
                }
            }

            postingAuth.account_auths.splice(i, 1);

            var tr = new window.bundle.TransactionBuilder();

            tr.add_type_operation("account_update", {
                account: accountName,
                posting: postingAuth,
                memo_key: account.memo_key,
                json_metadata: account.json_metadata
            });
            try {
                tr.process_transaction(login, null, true)
                .then(function(res) {
                    document.getElementById("success_message").innerText = "streemian post authorisation has been revoked."
                    lookUpAccount();
                }).catch(function(err) {
                    console.log("err:", err);
                })
            }
            catch(err) {
                console.err(err);
            }
        }

        function addStreemian(e) {
            e.preventDefault();

            var accountName = document.getElementById("account_name").value;
            var password = document.getElementById("password").value;
            var login = verifyLogin(account, password, null);
            if (!login) {
                setPasswordIncorrect();
                return;
            } else {
                document.getElementById("error_div").className = "";
                document.getElementById("error_warning").innerText = "";
            }

            var postingAuth = account.posting;
            postingAuth.account_auths.push([accountToAdd, postingAuth.weight_threshold]);

            var tr = new window.bundle.TransactionBuilder();

            tr.add_type_operation("account_update", {
                account: accountName,
                posting: postingAuth,
                memo_key: account.memo_key,
                json_metadata: account.json_metadata
            });

            try {
                var result = tr.process_transaction(login, null, true)
                .then(function(res) {
                    document.getElementById("success_message").innerText = "streemian successfully given post authorisation"
                    lookUpAccount();
                }).catch(function(err) {
                    console.log("err:", err);
                })
            }
            catch(err) {
                console.err(err);
            }
        }

        function verifyLogin(account, pass) {
            if (!pass) {
                setPasswordIncorrect();
                return false;
            }

            try {
                var passLogin = new window.bundle.Login();
                passLogin.setRoles(["active"]);
                var passCheck = passLogin.checkKeys({
                    accountName: account.name,
                    password: pass,
                    privateKey: null,
                    auths: {
                        active: account.active.key_auths
                    }}
                );

                if (passCheck) {
                    return passLogin;
                }

                var keyLogin = new window.bundle.Login();
                keyLogin.setRoles(["active"]);
                var keyCheck = keyLogin.checkKeys({
                    accountName: account.name,
                    password: null,
                    privateKey: pass,
                    auths: {
                        active: account.active.key_auths
                    }}
                );

                console.log("keyCheck", keyCheck);

                if (keyCheck) {
                    return keyLogin;
                }
            } catch(err) {
                console.log("err:", err);
                return false;
            }

            setPasswordIncorrect();
            return false;
        }

        // renderPosters();

    </script>
</body>
</html>
